#!/bin/bash

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

get_cpu_temp() {
    # Lee la temperatura y la divide entre 1000 para obtener grados Celsius
    cat /sys/class/thermal/thermal_zone0/temp | awk '{print $1/1000}'
}

get_cpu_freq() {
    # Lee la frecuencia del primer núcleo y la convierte a GHz
    cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_cur_freq | head -1 | awk '{printf "%.3f", $1/1000000}'
}

get_cpu_usage() {
    local stats1=$(cat /proc/stat)
    sleep 1
    local stats2=$(cat /proc/stat)

    awk -v stats1="$stats1" '
    BEGIN {
        max_core = -1; # Inicializa el contador de núcleos
        # Procesa la primera lectura para almacenar los valores iniciales
        split(stats1, lines1, "\n")
        for (i in lines1) {
            if (lines1[i] ~ /^(cpu[0-9]+)/) {
                split(lines1[i], fields, " ")
                core = fields[1]
                core_num = substr(core, 4) + 0 # Extrae y convierte a número
                if (core_num > max_core) {
                    max_core = core_num # Encuentra el núcleo con el número más alto
                }
                total1[core] = 0
                for(j=2; j<=length(fields); j++) total1[core] += fields[j]
                idle1[core] = fields[5] # La columna 5 es el tiempo 'idle'
            }
        }
    }
    /^(cpu[0-9]+)/ {
        # Procesa la segunda lectura para calcular el uso
        core = $1
        total2 = 0
        for(i=2; i<=NF; i++) total2 += $i
        idle2 = $5

        total_delta = total2 - total1[core]
        idle_delta = idle2 - idle1[core]

        if (total_delta > 0) {
            usage = ( (total_delta - idle_delta) / total_delta ) * 100
            core_num = substr(core, 4) + 0 # Extrae el número del núcleo
            usage_list[core_num] = sprintf("Core %s: %.1f%%", core_num, usage)
        }
    }
    END {
        # Imprime los resultados en orden numérico
        for (i = 0; i <= max_core; i++) {
            if (i in usage_list) {
                printf "%s", usage_list[i]
                if (i < max_core) printf ", "
            }
        }
    }
    ' <<< "$stats2"
}

while true;
do
    CPU_TEMP=$(get_cpu_temp)
    CPU_FREQ=$(get_cpu_freq)
    CPU_USAGE=$(get_cpu_usage)
	
    echo -e "${CYAN}$(date '+%Y-%m-%d %H:%M:%S')${NC}${BLUE}=================${NC}"
    echo -e "${GREEN} [CPU] Temp: ${CPU_TEMP}°C | Freq: ${CPU_FREQ}GHz ${NC}"
	echo -e "${YELLOW} Usage: [${CPU_USAGE}]${NC}"

	sleep 1
done